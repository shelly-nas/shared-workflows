name: 'Docker Compose Health Check'
description: 'Verify Docker Compose services are running and healthy'

inputs:
  working-directory:
    description: 'Working directory containing docker-compose file'
    required: false
    default: '.'
  compose-file:
    description: 'Path to docker-compose file'
    required: false
    default: 'docker-compose.yml'
  project-name:
    description: 'Docker Compose project name'
    required: false
    default: ''
  wait-time:
    description: 'Time to wait before checking (seconds)'
    required: false
    default: '10'
  max-retries:
    description: 'Maximum number of retries'
    required: false
    default: '3'
  retry-interval:
    description: 'Interval between retries (seconds)'
    required: false
    default: '5'

outputs:
  healthy:
    description: 'Whether all services are healthy'
    value: ${{ steps.check.outputs.healthy }}

runs:
  using: 'composite'
  steps:
    - name: Wait for services
      shell: bash
      run: |
        echo "::notice title=Waiting::Giving services ${{ inputs.wait-time }}s to start..."
        sleep ${{ inputs.wait-time }}

    - name: Health check
      id: check
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        COMPOSE="docker compose -f ${{ inputs.compose-file }}"
        [ -n "${{ inputs.project-name }}" ] && COMPOSE="$COMPOSE -p ${{ inputs.project-name }}"
        
        for i in $(seq 1 ${{ inputs.max-retries }}); do
          RUNNING=$($COMPOSE ps --services --filter "status=running" 2>/dev/null | wc -l | tr -d ' ')
          TOTAL=$($COMPOSE ps --services 2>/dev/null | wc -l | tr -d ' ')
          
          echo "::notice title=Check $i/${{ inputs.max-retries }}::Running: $RUNNING/$TOTAL"
          
          if [ "$RUNNING" -eq "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
            echo "::notice title=Healthy::All $TOTAL services are running"
            echo "healthy=true" >> $GITHUB_OUTPUT
            $COMPOSE ps
            exit 0
          fi
          
          [ $i -lt ${{ inputs.max-retries }} ] && sleep ${{ inputs.retry-interval }}
        done
        
        echo "::error title=Unhealthy::Only $RUNNING/$TOTAL services running"
        $COMPOSE ps
        $COMPOSE logs --tail=50
        echo "healthy=false" >> $GITHUB_OUTPUT
        exit 1
